define(["dojo/_base/array","game/util","dojo/request/script","dojo/promise/all"],function(i,j,l,m){var g=[],e=[],f=null,h=!1,k="reactiongifs";return{setSubreddit:function(a){k=a},getNextImage:function(){if(h)return null;if(null==f)return this._loadImages(),null;var a=f;this._prepareNextImage();return a},imageOk:function(a){return"failed"!=a},_prepareNextImage:function(){h||(0==g.length?(f=null,this._loadImages()):f=this._extractRandomImage())},_loadImages:function(){if(!h){h=!0;g=[];e=[];var a="http://www.reddit.com/r/"+
k+"/",a=[this._getDataFromReddit(a+".json"),this._getDataFromReddit(a+"new.json"),this._getDataFromReddit(a+"top.json","top","day"),this._getDataFromReddit(a+"top.json","top","hour"),this._getDataFromReddit(a+"top.json","top","week")],b=this;m(a).then(function(a){i.forEach(a,function(a){i.forEach(a,function(a){b._isGoodLink(a)&&-1==i.indexOf(e,a.data.title)&&(g.push({url:a.data.url,caption:a.data.title,redditUrl:"http://reddit.com/"+a.data.permalink}),e.push(a.data.title))})});(f=b._extractRandomImage())||
(f="failed");h=!1})}},_extractRandomImage:function(){if(0==g.length||3>e.length)return null;var a=j.spliceRandom(g),b=this._getRandomCaptions(3,a.caption);return{url:a.url,correct:a.caption,redditUrl:a.redditUrl,captions:b}},_getRandomCaptions:function(a,b){for(var d=[b];d.length<a;){var c=j.randomIndex(e),c=e[c];-1==i.indexOf(d,c)&&d.push(c)}return d},_getDataFromReddit:function(a,b,d){var c={limit:"100"};null!=b&&(c.sort=b);null!=d&&(c.t=d);return l.get(a,{jsonp:"jsonp",query:c,timeout:15E3}).then(function(a){return a.data.children},
function(){return[]})},_isGoodLink:function(a){if(!a||(!a.data||!a.data.url||!a.data.title||!a.data.score)||1>=a.data.score)return!1;var b=a.data.url.split("?")[0];return(b=/^https?:\/\/(?:[i.]|[edge.]|[www.])*imgur.com\/(?:r\/[\w]+\/)?([\w]{5,}(?:[&,][\w]{5,})?)(\.[\w]{3,4})?(?:#(\d*))?(?:\?(?:\d*))?$/i.exec(b))&&-1>=b[1].search(/[&,]/)&&!b[2]?(a.data.url="http://i.imgur.com/"+b[1]+".jpg",!0):/.jpe?g$/.test(a.data.url.toLowerCase())||/.png$/.test(a.data.url.toLowerCase())||/.gif$/.test(a.data.url.toLowerCase())||
/.bmp$/.test(a.data.url.toLowerCase())||/.tiff?$/.test(a.data.url.toLowerCase())?!0:!1}}});